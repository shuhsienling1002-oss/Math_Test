import streamlit as st
import random
import math
import time

# ==========================================
# 1. æ ¸å¿ƒï¼šé›²ç«¯é¡Œåº«è£½é€ æ©Ÿ (V7.0 çµ‚æ¥µèåˆç‰ˆ)
# ==========================================
# âŒ ç¢ºä¿ç„¡ Cacheï¼Œæ¯æ¬¡ç”Ÿæˆçµ•å°éš¨æ©Ÿ
def create_cloud_database():
    # è³‡æ–™åº«çµæ§‹ï¼šé›™å±¤ç´¢å¼• [å–®å…ƒ][é¡Œå‹]
    database = {
        "3-1 è­‰æ˜èˆ‡æ¨ç†": {"concept": [], "calc": [], "real": []},
        "3-2 ä¸‰è§’å½¢çš„å¤–å¿ƒ": {"concept": [], "calc": [], "real": []},
        "3-3 ä¸‰è§’å½¢çš„å…§å¿ƒ": {"concept": [], "calc": [], "real": []},
        "3-4 ä¸‰è§’å½¢çš„é‡å¿ƒ": {"concept": [], "calc": [], "real": []},
        "4-1 å› å¼åˆ†è§£æ³•": {"concept": [], "calc": [], "real": []},
        "4-2 é…æ–¹æ³•èˆ‡å…¬å¼è§£": {"concept": [], "calc": [], "real": []},
        "4-3 æ‡‰ç”¨å•é¡Œ": {"concept": [], "calc": [], "real": []}
    }

    # è¼”åŠ©å‡½å¼ï¼šå¿«é€Ÿæ³¨å…¥é¡Œç›®
    def add_q(unit, cat, q, opts, ans, expl, svg="none", params={}):
        database[unit][cat].append({
            "q": q, "options": opts, "ans": ans, "expl": expl, 
            "svg": svg, "svg_params": params, "type": cat
        })

    # =================================================================
    # å–®å…ƒ 3-1: è­‰æ˜èˆ‡æ¨ç†
    # =================================================================
    # [è§€å¿µé¡Œ] æ³¨å…¥ V5.0 çš„å…¨ç­‰/é™·é˜±/é€†æ•˜è¿°è®Šç•°
    for _ in range(50):
        subtype = random.randint(1, 3)
        if subtype == 1: # å…¨ç­‰æ€§è³ª
            prop = random.choice(["SSS", "SAS", "ASA", "AAS", "RHS"])
            add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "concept",
                  f"è‹¥å…©å€‹ä¸‰è§’å½¢æ»¿è¶³ã€Œ{prop}ã€å°æ‡‰ç›¸ç­‰ï¼Œå‰‡å®ƒå€‘çš„é—œä¿‚ç‚ºä½•ï¼Ÿ",
                  ["å¿…å…¨ç­‰", "ä¸ä¸€å®šå…¨ç­‰", "é¢ç©ç›¸ç­‰ä½†å½¢ç‹€ä¸åŒ", "ç›¸ä¼¼"],
                  "å¿…å…¨ç­‰", f"{prop} æ˜¯äº”å¤§ä¸‰è§’å½¢å…¨ç­‰åˆ¤åˆ¥æ€§è³ªä¹‹ä¸€ã€‚", "geometry_sas")
        elif subtype == 2: # é™·é˜±é¡Œ (SSA/AAA)
            bad = random.choice(["SSA", "AAA"])
            add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "concept",
                  f"ä¸‹åˆ—å“ªä¸€å€‹æ¢ä»¶ã€Œç„¡æ³•ã€ä¿è­‰ä¸‰è§’å½¢å…¨ç­‰ï¼Ÿ",
                  [bad, "SAS", "ASA", "SSS"],
                  bad, f"{bad} åªèƒ½ç¢ºå®šç›¸ä¼¼(AAA)æˆ–ä¸ç¢ºå®š(SSA)ï¼Œéå…¨ç­‰æ€§è³ªã€‚")
        else: # ä¸­å‚ç·š/è§’å¹³åˆ†ç·šè§€å¿µ
            q_text = random.choice([
                "ä¸­å‚ç·šä¸Šä»»ä¸€é»åˆ°å“ªè£¡çš„è·é›¢ç›¸ç­‰ï¼Ÿ",
                "è§’å¹³åˆ†ç·šä¸Šä»»ä¸€é»åˆ°å“ªè£¡çš„è·é›¢ç›¸ç­‰ï¼Ÿ"
            ])
            ans = "ç·šæ®µå…©ç«¯é»" if "ä¸­å‚ç·š" in q_text else "è§’çš„å…©é‚Š"
            opts = ["ç·šæ®µå…©ç«¯é»", "è§’çš„å…©é‚Š", "ä¸‰è§’å½¢é ‚é»", "ç„¡æ³•åˆ¤æ–·"]
            add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "concept", q_text, opts, ans, "å¹¾ä½•è»Œè·¡çš„åŸºæœ¬æ€§è³ªã€‚")

    # [è¨ˆç®—é¡Œ] æ³¨å…¥ V5.0 çš„è§’åº¦/é‚Šé•·/å¤šé‚Šå½¢è¨ˆç®—
    for _ in range(50):
        subtype = random.randint(1, 3)
        if subtype == 1: # å¤–è§’èˆ‡å…§è§’
            a, b = random.randint(50, 80), random.randint(20, 40)
            add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "calc",
                  f"â–³ABC ä¸­ï¼Œâˆ A={a}Â°ï¼Œâˆ B={b}Â°ï¼Œå‰‡ âˆ C çš„å¤–è§’æ˜¯å¤šå°‘åº¦ï¼Ÿ",
                  [str(a+b), str(180-a-b), "180", "90"],
                  str(a+b), "å¤–è§’å®šç†ï¼šå¤–è§’ç­‰æ–¼ä¸ç›¸é„°å…©å…§è§’å’Œã€‚")
        elif subtype == 2: # å¤šé‚Šå½¢å…§è§’
            n = random.choice([5, 6, 8, 10, 12])
            add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "calc",
                  f"æ­£ {n} é‚Šå½¢çš„å…§è§’ç¸½å’Œæ˜¯å¤šå°‘åº¦ï¼Ÿ",
                  [str((n-2)*180), str(n*180), "360", "720"],
                  str((n-2)*180), "å…§è§’å’Œå…¬å¼ (n-2)Ã—180ã€‚")
        else: # é‚Šè§’é—œä¿‚åˆ¤æ–·
            s = random.randint(5, 15)
            add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "calc",
                  f"ä¸‰è§’å½¢å…©é‚Šé•·ç‚º {s} å’Œ {s} (ç­‰è…°)ï¼Œç¬¬ä¸‰é‚Šé•·å¯èƒ½æ˜¯ï¼Ÿ",
                  [str(s), str(2*s), str(2*s+1), "0"],
                  str(s), "ä¸‰è§’å½¢å…©é‚Šå’Œ > ç¬¬ä¸‰é‚Šã€‚")

    # [æƒ…å¢ƒé¡Œ] æ³¨å…¥ V5.0 çš„æœ¨å·¥/å¸ç®¡/æ¸¬é‡
    for _ in range(50):
        add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "real",
              "æœ¨å·¥å¸«å‚…æƒ³ç¢ºèªä¸€å¡Šä¸‰è§’å½¢æœ¨æ¿æ˜¯å¦ç‚ºç­‰è…°ä¸‰è§’å½¢ï¼Œä»–é‡äº†å…©å€‹åº•è§’ç™¼ç¾ç›¸ç­‰ï¼Œé€™æ˜¯åˆ©ç”¨ï¼Ÿ",
              ["ç­‰è§’å°ç­‰é‚Š", "å¤§è§’å°å¤§é‚Š", "å…§è§’å’Œ 180", "å¤–è§’å®šç†"],
              "ç­‰è§’å°ç­‰é‚Š", "å…©åº•è§’ç›¸ç­‰å‰‡å°é‚Š(è…°)ç›¸ç­‰ã€‚")
        
        s1, s2 = random.randint(3, 8), random.randint(3, 8)
        add_q("3-1 è­‰æ˜èˆ‡æ¨ç†", "real",
              f"å°æ˜æœ‰å…©æ ¹é•·åº¦ç‚º {s1}, {s2} çš„å¸ç®¡ï¼Œæƒ³å‰ªç¬¬ä¸‰æ ¹å¸ç®¡åœæˆä¸‰è§’å½¢ï¼Œç¬¬ä¸‰æ ¹é•·åº¦ x éœ€æ»¿è¶³ï¼Ÿ",
              [f"{abs(s1-s2)} < x < {s1+s2}", f"x > {s1+s2}", f"x = {s1+s2}", "ç„¡é™åˆ¶"],
              f"{abs(s1-s2)} < x < {s1+s2}", "ä¸‰è§’å½¢å…©é‚Šå’Œ > ç¬¬ä¸‰é‚Šï¼Œå…©é‚Šå·® < ç¬¬ä¸‰é‚Šã€‚")

    # =================================================================
    # å–®å…ƒ 3-2: å¤–å¿ƒ
    # =================================================================
    # [è§€å¿µé¡Œ]
    for _ in range(50):
        add_q("3-2 ä¸‰è§’å½¢çš„å¤–å¿ƒ", "concept",
              "ä¸‰è§’å½¢çš„å¤–å¿ƒæ˜¯å“ªä¸‰æ¢ç·šçš„äº¤é»ï¼Ÿ",
              ["ä¸­å‚ç·š", "è§’å¹³åˆ†ç·š", "ä¸­ç·š", "é«˜"],
              "ä¸­å‚ç·š", "å¤–å¿ƒå®šç¾©ï¼šä¸‰é‚Šå‚ç›´å¹³åˆ†ç·šäº¤é»ã€‚")
        
        tri_type = random.choice([("éˆè§’", "å¤–éƒ¨"), ("ç›´è§’", "æ–œé‚Šä¸­é»"), ("éŠ³è§’", "å…§éƒ¨")])
        add_q("3-2 ä¸‰è§’å½¢çš„å¤–å¿ƒ", "concept",
              f"ã€Œ{tri_type[0]}ä¸‰è§’å½¢ã€çš„å¤–å¿ƒä½ç½®åœ¨å“ªè£¡ï¼Ÿ",
              [tri_type[1], "é ‚é»", "ä¸ä¸€å®š", "é‡å¿ƒ"],
              tri_type[1], f"{tri_type[0]}ä¸‰è§’å½¢å¤–å¿ƒåœ¨{tri_type[1]}ã€‚")

    # [è¨ˆç®—é¡Œ]
    for _ in range(50):
        subtype = random.randint(1, 2)
        if subtype == 1: # ç›´è§’åŠå¾‘
            c = random.choice([10, 13, 17, 25, 26, 30])
            add_q("3-2 ä¸‰è§’å½¢çš„å¤–å¿ƒ", "calc",
                  f"ç›´è§’ä¸‰è§’å½¢æ–œé‚Šé•·ç‚º {c}ï¼Œæ±‚å¤–æ¥åœ“åŠå¾‘ Rï¼Ÿ",
                  [str(c/2), str(c), str(c*2), str(c/3)],
                  str(c/2), "ç›´è§’ä¸‰è§’å½¢å¤–æ¥åœ“åŠå¾‘ = æ–œé‚Šçš„ä¸€åŠã€‚", "triangle_circumcenter")
        else: # åº§æ¨™
            k = random.randint(2, 6) * 2
            add_q("3-2 ä¸‰è§’å½¢çš„å¤–å¿ƒ", "calc",
                  f"åº§æ¨™å¹³é¢ä¸Š A(0,{k}), B({k},0), O(0,0)ï¼Œæ±‚ â–³ABO å¤–å¿ƒåº§æ¨™ï¼Ÿ",
                  [f"({k//2},{k//2})", f"({k},{k})", "(0,0)", f"({k//3},{k//3})"],
                  f"({k//2},{k//2})", "ç›´è§’ä¸‰è§’å½¢å¤–å¿ƒç‚ºæ–œé‚Šä¸­é»ã€‚")

    # [æƒ…å¢ƒé¡Œ]
    for _ in range(50):
        add_q("3-2 ä¸‰è§’å½¢çš„å¤–å¿ƒ", "real",
              "ä¸‰å€‹æ‘èŠ A, B, C æƒ³è¦è“‹ä¸€åº§å…±ç”¨çš„æ°´å¡”ï¼Œè¦æ±‚åˆ°ä¸‰æ‘èŠè·é›¢ç›¸ç­‰ï¼Œæ‡‰è“‹åœ¨ï¼Ÿ",
              ["â–³ABC çš„å¤–å¿ƒ", "â–³ABC çš„å…§å¿ƒ", "â–³ABC çš„é‡å¿ƒ", "AB ç·šæ®µä¸Š"],
              "â–³ABC çš„å¤–å¿ƒ", "å¤–å¿ƒåˆ°ä¸‰é ‚é»ç­‰è·é›¢ã€‚")
        
        add_q("3-2 ä¸‰è§’å½¢çš„å¤–å¿ƒ", "real",
              "åœ“å½¢å¤è¹Ÿç ´è£‚æ®˜ç¼ºï¼Œè€ƒå¤å­¸å®¶æƒ³æ‰¾å›åœ“å¿ƒå¾©åŸï¼Œæ‡‰è©²åœ¨åœ“å¼§ä¸Šå–é»åšä»€éº¼ç·šï¼Ÿ",
              ["å¼¦çš„ä¸­å‚ç·š", "åˆ‡ç·š", "è§’å¹³åˆ†ç·š", "ä¸­ç·š"],
              "å¼¦çš„ä¸­å‚ç·š", "åœ“å¿ƒå¿…åœ¨å¼¦çš„ä¸­å‚ç·šä¸Šï¼Œå…©æ¢ä¸­å‚ç·šäº¤é»å³åœ“å¿ƒã€‚")

    # =================================================================
    # å–®å…ƒ 3-3: å…§å¿ƒ
    # =================================================================
    # [è§€å¿µé¡Œ]
    for _ in range(50):
        add_q("3-3 ä¸‰è§’å½¢çš„å…§å¿ƒ", "concept",
              "å…§å¿ƒåˆ°ä¸‰è§’å½¢å“ªè£¡çš„è·é›¢ç›¸ç­‰ï¼Ÿ",
              ["ä¸‰é‚Š", "ä¸‰é ‚é»", "ä¸‰ä¸­é»", "å¤–éƒ¨"],
              "ä¸‰é‚Š", "å…§å¿ƒç‚ºå…§åˆ‡åœ“åœ“å¿ƒï¼ŒåŠå¾‘å³ç‚ºåˆ°ä¸‰é‚Šè·é›¢ã€‚")
        
        add_q("3-3 ä¸‰è§’å½¢çš„å…§å¿ƒ", "concept",
              "å°ºè¦ä½œåœ–æ‰¾å…§å¿ƒï¼Œéœ€è¦åšä»€éº¼ï¼Ÿ",
              ["è§’å¹³åˆ†ç·š", "ä¸­å‚ç·š", "ä¸­ç·š", "é«˜"],
              "è§’å¹³åˆ†ç·š", "å…§å¿ƒæ˜¯ä¸‰å…§è§’å¹³åˆ†ç·šäº¤é»ã€‚")

    # [è¨ˆç®—é¡Œ]
    for _ in range(50):
        subtype = random.randint(1, 2)
        if subtype == 1: # è§’åº¦
            deg = random.choice([40, 50, 60, 70, 80])
            add_q("3-3 ä¸‰è§’å½¢çš„å…§å¿ƒ", "calc",
                  f"I ç‚ºå…§å¿ƒï¼Œâˆ A={deg}Â°ï¼Œæ±‚ âˆ BICï¼Ÿ",
                  [str(90+deg//2), str(180-deg), str(90+deg), str(deg)],
                  str(90+deg//2), "å…¬å¼ï¼š90 + A/2ã€‚", "triangle_incenter", {"a": deg})
        else: # é¢ç©åæ¨
            s = random.randint(10, 20)
            r = random.randint(2, 5)
            area = s * r // 2
            add_q("3-3 ä¸‰è§’å½¢çš„å…§å¿ƒ", "calc",
                  f"ä¸‰è§’å½¢å‘¨é•· {s}ï¼Œå…§åˆ‡åœ“åŠå¾‘ {r}ï¼Œæ±‚é¢ç©ï¼Ÿ",
                  [str(area), str(s*r), str(area*2), str(s+r)],
                  str(area), "é¢ç© = rs/2ã€‚")

    # [æƒ…å¢ƒé¡Œ]
    for _ in range(50):
        add_q("3-3 ä¸‰è§’å½¢çš„å…§å¿ƒ", "real",
              "æƒ³è¦åœ¨ä¸‰è§’å½¢å…¬åœ’å…§è“‹ä¸€å€‹åœ“å½¢å™´æ°´æ± ï¼Œä¸”åœ“é¢ç©æœ€å¤§(ä¸è¶…å‡ºé‚Šç•Œ)ï¼Œåœ“å¿ƒæ‡‰é¸ï¼Ÿ",
              ["å…§å¿ƒ", "å¤–å¿ƒ", "é‡å¿ƒ", "é ‚é»"],
              "å…§å¿ƒ", "å…§åˆ‡åœ“æ˜¯ä¸‰è§’å½¢å…§éƒ¨æœ€å¤§çš„åœ“ã€‚")

    # =================================================================
    # å–®å…ƒ 3-4: é‡å¿ƒ
    # =================================================================
    # [è§€å¿µé¡Œ]
    for _ in range(50):
        add_q("3-4 ä¸‰è§’å½¢çš„é‡å¿ƒ", "concept",
              "ä¸‰è§’å½¢çš„é‡å¿ƒæ˜¯å“ªä¸‰æ¢ç·šçš„äº¤é»ï¼Ÿ",
              ["ä¸­ç·š", "ä¸­å‚ç·š", "è§’å¹³åˆ†ç·š", "é«˜"],
              "ä¸­ç·š", "é‡å¿ƒå®šç¾©ã€‚")

    # [è¨ˆç®—é¡Œ]
    for _ in range(50):
        subtype = random.randint(1, 2)
        if subtype == 1: # é•·åº¦æ¯”
            m = random.randint(3, 9) * 3
            add_q("3-4 ä¸‰è§’å½¢çš„é‡å¿ƒ", "calc",
                  f"G ç‚ºé‡å¿ƒï¼Œä¸­ç·š AD é•·ç‚º {m}ï¼Œæ±‚ AGï¼Ÿ",
                  [str(m*2//3), str(m//3), str(m), str(m//2)],
                  str(m*2//3), "é‡å¿ƒåˆ°é ‚é»è·é›¢ç‚ºä¸­ç·šé•·çš„ 2/3ã€‚", "triangle_centroid", {"m": m})
        else: # é¢ç©åˆ†å‰²
            area = random.randint(6, 12) * 6
            add_q("3-4 ä¸‰è§’å½¢çš„é‡å¿ƒ", "calc",
                  f"â–³ABC é¢ç© {area}ï¼ŒG ç‚ºé‡å¿ƒã€‚å‰‡ â–³GAB é¢ç©ç‚ºï¼Ÿ",
                  [str(area//3), str(area//2), str(area//6), str(area)],
                  str(area//3), "é‡å¿ƒèˆ‡é ‚é»é€£ç·šå°‡é¢ç©ä¸‰ç­‰åˆ†ã€‚")

    # [æƒ…å¢ƒé¡Œ]
    for _ in range(50):
        add_q("3-4 ä¸‰è§’å½¢çš„é‡å¿ƒ", "real",
              "ç«¥è»èª²è£½ä½œä¸‰è§’å½¢æœ¨æ¿ï¼Œæƒ³ç”¨ä¸€æ ¹æ‰‹æŒ‡é ‚ä½æœ¨æ¿è®“å®ƒå¹³è¡¡ï¼Œæ‰‹æŒ‡è¦æ”¾åœ¨ï¼Ÿ",
              ["é‡å¿ƒ", "å…§å¿ƒ", "å¤–å¿ƒ", "å‚å¿ƒ"],
              "é‡å¿ƒ", "é‡å¿ƒæ˜¯ç‰©é«”çš„é‡é‡ä¸­å¿ƒã€‚")

    # =================================================================
    # å–®å…ƒ 4-1: å› å¼åˆ†è§£
    # =================================================================
    # [è§€å¿µé¡Œ]
    for _ in range(50):
        add_q("4-1 å› å¼åˆ†è§£æ³•", "concept",
              "è‹¥ (x-a)(x-b) = 0ï¼Œå‰‡ä¸‹åˆ—æ¨è«–ä½•è€…æ­£ç¢ºï¼Ÿ",
              ["x=a æˆ– x=b", "x=a ä¸” x=b", "x=0", "a=b"],
              "x=a æˆ– x=b", "é›¶ç©æ€§è³ªã€‚")

    # [è¨ˆç®—é¡Œ]
    for _ in range(50):
        subtype = random.randint(1, 2)
        if subtype == 1: # å¹³æ–¹å·®
            k = random.randint(2, 9)
            add_q("4-1 å› å¼åˆ†è§£æ³•", "calc",
                  f"å› å¼åˆ†è§£ xÂ² - {k*k}ï¼Ÿ",
                  [f"(x+{k})(x-{k})", f"(x-{k})Â²", f"(x+{k})Â²", "ç„¡æ³•åˆ†è§£"],
                  f"(x+{k})(x-{k})", "å¹³æ–¹å·®å…¬å¼ã€‚")
        else: # åå­—äº¤ä¹˜
            a, b = random.randint(1, 5), random.randint(1, 5)
            add_q("4-1 å› å¼åˆ†è§£æ³•", "calc",
                  f"å› å¼åˆ†è§£ xÂ² + {a+b}x + {a*b}ï¼Ÿ",
                  [f"(x+{a})(x+{b})", f"(x-{a})(x-{b})", f"(x+{a})(x-{b})", "ç„¡è§£"],
                  f"(x+{a})(x+{b})", "åå­—äº¤ä¹˜æ³•ã€‚")

    # [æƒ…å¢ƒé¡Œ]
    for _ in range(50):
        area = random.randint(10, 50)
        add_q("4-1 å› å¼åˆ†è§£æ³•", "real",
              f"é•·æ–¹å½¢é¢ç© {area}ï¼Œé•·å¯¬çš†ç‚ºæ•´æ•¸ï¼Œè«‹å•é•·å¯¬å¯èƒ½æ˜¯ï¼Ÿ(å› å¼åˆ†è§£æ¦‚å¿µ)",
              ["éœ€æ‰¾å‡ºé¢ç©çš„å› æ•¸", "éœ€æ‰¾å‡ºé¢ç©çš„å€æ•¸", "ä¸€å®šæ˜¯æ­£æ–¹å½¢", "ç„¡æ³•åˆ¤æ–·"],
              "éœ€æ‰¾å‡ºé¢ç©çš„å› æ•¸", "é•· Ã— å¯¬ = é¢ç©ï¼Œæ•…é•·å¯¬ç‚ºé¢ç©çš„å› æ•¸ã€‚")

    # =================================================================
    # å–®å…ƒ 4-2: é…æ–¹æ³•
    # =================================================================
    # [è§€å¿µé¡Œ]
    for _ in range(50):
        add_q("4-2 é…æ–¹æ³•èˆ‡å…¬å¼è§£", "concept",
              "ä¸€å…ƒäºŒæ¬¡æ–¹ç¨‹å¼åˆ¤åˆ¥å¼ D < 0 ä»£è¡¨ï¼Ÿ",
              ["ç„¡å¯¦æ ¹", "é‡æ ¹", "å…©ç›¸ç•°å¯¦æ ¹", "æœ‰ä¸‰å€‹æ ¹"],
              "ç„¡å¯¦æ ¹", "D < 0 åœ–å½¢èˆ‡ x è»¸ç„¡äº¤é»ã€‚")

    # [è¨ˆç®—é¡Œ]
    for _ in range(50):
        k = random.choice([4, 6, 8, 10, 12])
        add_q("4-2 é…æ–¹æ³•èˆ‡å…¬å¼è§£", "calc",
              f"xÂ² + {k}x + â–¡ é…æˆå®Œå…¨å¹³æ–¹å¼ï¼Œâ–¡ = ï¼Ÿ",
              [str((k//2)**2), str(k), str(k*2), "1"],
              str((k//2)**2), "è£œé …å…¬å¼ï¼š(ä¿‚æ•¸/2)Â²ã€‚", "area_square_k")

    # [æƒ…å¢ƒé¡Œ]
    for _ in range(50):
        add_q("4-2 é…æ–¹æ³•èˆ‡å…¬å¼è§£", "real",
              "åˆ©ç”¨å…¬å¼è§£æ±‚å‡ºæ™‚é–“ t = 3 Â± âˆš(-5)ï¼Œé€™ä»£è¡¨ä»€éº¼ç‰©ç†æ„ç¾©ï¼Ÿ",
              ["ç„¡è§£(ä¸å¯èƒ½ç™¼ç”Ÿ)", "æœ‰å…©å€‹æ™‚é–“é»", "æ™‚é–“å€’æµ", "è¨ˆç®—éŒ¯èª¤"],
              "ç„¡è§£(ä¸å¯èƒ½ç™¼ç”Ÿ)", "æ ¹è™Ÿå…§ç‚ºè² æ•¸(ç„¡å¯¦æ•¸è§£)ï¼Œä»£è¡¨ç‰©é«”é”ä¸åˆ°è©²é«˜åº¦ã€‚")

    # =================================================================
    # å–®å…ƒ 4-3: æ‡‰ç”¨å•é¡Œ
    # =================================================================
    # [è§€å¿µé¡Œ]
    for _ in range(50):
        add_q("4-3 æ‡‰ç”¨å•é¡Œ", "concept",
              "è§£æ‡‰ç”¨å•é¡Œç®—å‡ºé‚Šé•·ç‚º -5ï¼Œæ‡‰è©²å¦‚ä½•è™•ç†ï¼Ÿ",
              ["ä¸åˆ(æ¨å»)", "å–çµ•å°å€¼", "ç•¶ä½œç­”æ¡ˆ", "é‡ç®—"],
              "ä¸åˆ(æ¨å»)", "å¹¾ä½•é•·åº¦å¿…é ˆç‚ºæ­£æ•¸ã€‚")

    # [è¨ˆç®—é¡Œ]
    for _ in range(50):
        n = random.randint(1, 10)
        add_q("4-3 æ‡‰ç”¨å•é¡Œ", "calc",
              f"æŸæ•¸å¹³æ–¹æ¯”è©²æ•¸å¤§ {n*(n-1)}ï¼Œæ±‚è©²æ•¸(æ­£æ•´æ•¸)ï¼Ÿ",
              [str(n), str(n+1), str(n-1), "0"],
              str(n), f"xÂ² - x = {n*(n-1)}ï¼Œè§£å¾— x={n}ã€‚")

    # [æƒ…å¢ƒé¡Œ]
    for _ in range(50):
        subtype = random.randint(1, 2)
        if subtype == 1: # æ‹‹é«”
            t = random.randint(2, 5)
            add_q("4-3 æ‡‰ç”¨å•é¡Œ", "real",
                  f"ç…™ç«ç™¼å°„é«˜åº¦ h = 20t - 5tÂ²ã€‚åœ¨ t={t} ç§’æ™‚é«˜åº¦ç‚º {20*t - 5*t*t}ï¼Œæ±‚ tï¼Ÿ",
                  [str(t), str(t+1), "0", "10"],
                  str(t), "ä»£å…¥å…¬å¼è§£æ–¹ç¨‹å¼ã€‚")
        else: # æ¢¯å­
            a, b, c = random.choice([(3,4,5), (5,12,13), (8,15,17)])
            add_q("4-3 æ‡‰ç”¨å•é¡Œ", "real",
                  f"æ¢¯å­é•· {c} å…¬å°ºï¼Œæ¢¯è…³é›¢ç‰† {a} å…¬å°ºï¼Œæ¢¯é ‚é«˜åº¦ï¼Ÿ",
                  [str(b), str(c), str(a+b), str(c-a)],
                  str(b), f"âˆš({c}Â² - {a}Â²) = {b}ã€‚")

    return database

# ==========================================
# 2. è¦–è¦ºç¹ªåœ–å¼•æ“ (å®Œå…¨ä¿ç•™)
# ==========================================
class SVGDrawer:
    @staticmethod
    def draw(svg_type, **kwargs):
        base = '<svg width="300" height="200" xmlns="http://www.w3.org/2000/svg"><rect width="100%" height="100%" fill="white"/>{}</svg>'
        mx = lambda v: 150 + v*12
        if svg_type == "geometry_sas":
            return base.format('<path d="M20,120 L80,120 L50,40 Z" fill="none" stroke="black"/><path d="M150,120 L210,120 L180,40 Z" fill="none" stroke="black"/><text x="110" y="80" fill="blue">å…¨ç­‰?</text>')
        elif svg_type == "triangle_centroid":
            return base.format('<path d="M150,20 L50,180 L250,180 Z" fill="none" stroke="black"/><line x1="150" y1="20" x2="150" y2="180" stroke="red"/><circle cx="150" cy="126" r="5" fill="blue"/><text x="160" y="130" fill="blue">G</text>')
        elif svg_type == "triangle_circumcenter":
            return base.format('<circle cx="150" cy="100" r="80" fill="none" stroke="green"/><path d="M150,20 L80,140 L220,140 Z" fill="none" stroke="black"/><circle cx="150" cy="100" r="4" fill="green"/><text x="150" y="90" fill="green">O</text>')
        elif svg_type == "triangle_incenter":
            return base.format('<path d="M150,30 L50,170 L250,170 Z" fill="none" stroke="black"/><circle cx="150" cy="120" r="4" fill="orange"/><text x="150" y="110" fill="orange">I</text>')
        elif svg_type == "area_square":
            return base.format('<rect x="100" y="50" width="100" height="100" fill="#e3f2fd" stroke="black"/><text x="150" y="105" text-anchor="middle">é¢ç©</text>')
        elif svg_type == "area_square_k":
            return base.format('<rect x="100" y="50" width="100" height="100" fill="#fff3e0" stroke="black" stroke-dasharray="4"/><text x="150" y="105" text-anchor="middle">è£œé …?</text>')
        return ""

# ==========================================
# 3. APP ä»‹é¢ (çµæ§‹åŒ–æŠ½é¡Œ + æ¨™ç±¤é¡¯ç¤º)
# ==========================================
st.set_page_config(page_title="åœ‹ä¸­æ•¸å­¸é›²ç«¯æ•™å®¤", page_icon="â˜ï¸")
st.title("â˜ï¸ åœ‹ä¸­æ•¸å­¸æ™ºèƒ½é¡Œåº« (V7.0 çµ‚æ¥µèåˆç‰ˆ)")

if 'quiz' not in st.session_state: st.session_state.quiz = []
if 'exam_finished' not in st.session_state: st.session_state.exam_finished = False

data = create_cloud_database()
st.sidebar.success(f"âœ… é¡Œåº«ç”Ÿæˆå®Œç•¢ï¼(å·²åˆ†é¡ç‚ºè§€å¿µ/è¨ˆç®—/æƒ…å¢ƒ)")

unit_options = list(data.keys()) + ["å…¨ç¯„åœç¸½è¤‡ç¿’"]
unit = st.sidebar.selectbox("è«‹é¸æ“‡ç·´ç¿’å–®å…ƒ", unit_options)

# --- æ ¸å¿ƒä¿®æ”¹ï¼šçµæ§‹åŒ–æŠ½é¡Œ ---
if st.sidebar.button("ğŸš€ ç”Ÿæˆè©¦å· (2è§€å¿µ+2è¨ˆç®—+2æƒ…å¢ƒ)"):
    quiz_set = []
    
    # æº–å‚™é¡Œåº«æ± 
    if unit == "å…¨ç¯„åœç¸½è¤‡ç¿’":
        pool_concept = []
        pool_calc = []
        pool_real = []
        for k in data:
            pool_concept.extend(data[k]["concept"])
            pool_calc.extend(data[k]["calc"])
            pool_real.extend(data[k]["real"])
    else:
        pool_concept = data[unit]["concept"]
        pool_calc = data[unit]["calc"]
        pool_real = data[unit]["real"]
    
    # å¼·åˆ¶å„æŠ½ 2 é¡Œ (è‹¥ä¸è¶³å‰‡å…¨å–)
    random.seed(time.time())
    q1 = random.sample(pool_concept, min(len(pool_concept), 2))
    q2 = random.sample(pool_calc, min(len(pool_calc), 2))
    q3 = random.sample(pool_real, min(len(pool_real), 2))
    
    # åˆä½µä¸¦æ‰“äº‚é †åº
    quiz_set = q1 + q2 + q3
    random.shuffle(quiz_set)
    
    st.session_state.quiz = quiz_set
    st.session_state.exam_finished = False
    st.rerun()

if st.session_state.quiz and not st.session_state.exam_finished:
    with st.form("quiz_form"):
        u_answers = []
        for i, q in enumerate(st.session_state.quiz):
            # é¡¯ç¤ºé¡Œå‹æ¨™ç±¤
            type_map = {"concept": "è§€å¿µ", "calc": "è¨ˆç®—", "real": "æƒ…å¢ƒ"}
            badge = type_map.get(q['type'], "ç¶œåˆ")
            
            st.markdown(f"### Q{i+1} <span style='background-color:#e0f7fa; padding:2px 8px; border-radius:4px; font-size:0.7em; color:#006064'>{badge}</span> {q['q']}", unsafe_allow_html=True)
            
            if q['svg'] != "none":
                st.markdown(SVGDrawer.draw(q['svg'], **q.get('svg_params', {}) if 'svg_params' in q else {}), unsafe_allow_html=True)
            u_ans = st.radio("é¸æ“‡ç­”æ¡ˆ", q['options'], key=f"q_{i}", label_visibility="collapsed")
            u_answers.append(u_ans)
            st.divider()
        if st.form_submit_button("âœ… äº¤å·", use_container_width=True):
            st.session_state.results = u_answers
            st.session_state.exam_finished = True
            st.rerun()

if st.session_state.exam_finished:
    score = 0
    for i, q in enumerate(st.session_state.quiz):
        is_correct = st.session_state.results[i] == q['ans']
        if is_correct: score += 1
        with st.expander(f"ç¬¬ {i+1} é¡Œ: {'âœ… æ­£ç¢º' if is_correct else 'âŒ éŒ¯èª¤'}"):
            st.write(f"é¡Œç›®: {q['q']}")
            st.write(f"æ‚¨çš„ç­”æ¡ˆ: {st.session_state.results[i]}")
            st.write(f"æ­£ç¢ºç­”æ¡ˆ: {q['ans']}")
            st.info(f"è§£æ: {q['expl']}")
    
    final_score = int((score / 6) * 100)
    st.success(f"## æ‚¨çš„æœ€çµ‚å¾—åˆ†: {final_score} åˆ†")
    if st.button("ğŸ”„ é‡æ–°æŒ‘æˆ°", use_container_width=True):
        st.session_state.quiz = []
        st.session_state.exam_finished = False
        st.rerun()
